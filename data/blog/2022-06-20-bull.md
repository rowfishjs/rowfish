---

slug: bull-usage

title: è€ç‰ˆæœ¬Bullä½¿ç”¨æ•™ç¨‹

authors: pincman

tags: [bull,queue,mq,bullmq,typescript,nestjs]

rf_summary: Bullæ˜¯Nodeä¸‹ä¸€ä¸ªæ¯”è¾ƒå¥½æ¶ˆæ¯åˆ—é˜Ÿç±»åº“,ä¸Nestjsæ•´åˆçš„å¾ˆå¥½ã€‚<br />è¿™ç¯‡ä¸ä¸Šä¸€ç¯‡ä¸€æ ·æ¬è¿è€æ–‡ç« ,æ–°ç‰ˆBullMQçš„æ–‡æ¡£æ¯”è¾ƒå¤§ï¼Œæˆ‘åé¢æœ‰ç©ºä¼šç¿»è¯‘ç¿»è¯‘,å¯ä»¥åˆ°èµ„æºæ ç›®æŸ¥çœ‹ğŸ˜

---

# Node.jsåˆ—é˜Ÿå¤„ç†-BullMQä¸­æ–‡æ•™ç¨‹

## åŸºæœ¬æ¦‚å¿µ

### Bullæ˜¯ä»€ä¹ˆ?

> ä»»åŠ¡åˆ—é˜Ÿä¸€èˆ¬ç”¨äºå¼‚æ­¥å¤„ç†è§†é¢‘è½¬ç ,å‘é€çŸ­ä¿¡ç­‰è€—æ—¶ä»»åŠ¡,ä¸è‡³äºAPIæ¥å£è¿æ¥å¡æ­»

Bullæ˜¯ä¸€ä¸ªNodeåº“ï¼Œå®ƒåŸºäº [redis](https://redis.io/)å®ç°äº†å¿«é€Ÿè€Œå¼ºå¤§çš„é˜Ÿåˆ—ç³»ç»Ÿã€‚ 

å°½ç®¡å¯ä»¥ä½¿ç”¨Rediså‘½ä»¤ç›´æ¥å®ç°é˜Ÿåˆ—ï¼Œä½†æ˜¯è¯¥åº“æä¾›äº†ä¸€ä¸ªAPIï¼Œè¯¥APIå¯ä»¥å¤„ç†æ‰€æœ‰åº•å±‚ç»†èŠ‚å¹¶ä¸°å¯Œäº†RedisåŸºæœ¬åŠŸèƒ½ï¼Œå› æ­¤å¯ä»¥è½»æ¾å¤„ç†æ›´å¤æ‚çš„ç”¨ä¾‹ã€‚

 å¦‚æœæ‚¨ä¸ç†Ÿæ‚‰é˜Ÿåˆ—ï¼Œæ‚¨å¯èƒ½ä¼šæƒ³çŸ¥é“ä¸ºä»€ä¹ˆéœ€è¦å®ƒã€‚é˜Ÿåˆ—å¯ä»¥ç”¨ä¸€ç§ä¼˜é›…çš„æ–¹å¼è§£å†³è®¸å¤šä¸åŒçš„é—®é¢˜ï¼Œæ¯”å¦‚åœ¨å¾®æœåŠ¡ä¹‹é—´åˆ›å»ºå¥å£®çš„é€šä¿¡é€šé“æ¥å¹³æ»‘åœ°å¤„ç†CPUé«˜å³°ï¼Œæˆ–å°†ç¹é‡çš„å·¥ä½œä»ä¸€å°æœåŠ¡å™¨è½¬ç§»åˆ°è®¸å¤šè¾ƒå°çš„å·¥ä½œåŒºé—´ç­‰ã€‚

### å¼€å§‹

å®‰è£…Bull:

```shell
$ npm install bull --save && npm install @types/bull --save-dev
```

æˆ–è€…

```shell
$ yarn add bull && yarn add --dev @types/bull
```

ä¸ºäº†ä½¿ç”¨bull,ä½ å¿…é¡»å…ˆå®‰è£…Redis.åœ¨æœ¬åœ°å¼€å‘ç¯å¢ƒä½¿ç”¨[docker](https://hub.docker.com/_/redis/)å¯ä»¥æ–¹ä¾¿çš„å®‰è£….Bullé»˜è®¤ä½¿ç”¨ `localhost:6379`æ¥è¿æ¥Redis.

#### ç®€å•åˆ—é˜Ÿ

åªéœ€é€šè¿‡å®ä¾‹åŒ–Bullå®ä¾‹å³å¯åˆ›å»ºé˜Ÿåˆ—:

```javascript
const myFirstQueue = new Bull('my-first-queue');
```

ä¸€ä¸ªé˜Ÿåˆ—å®ä¾‹é€šå¸¸å¯ä»¥æœ‰ 3 ä¸ªä¸»è¦ä¸åŒçš„è§’è‰²ï¼šä»»åŠ¡ç”Ÿäº§è€…ã€ä»»åŠ¡æ¶ˆè´¹è€…æˆ–ä»¥åŠäº‹ä»¶ç›‘å¬å™¨ã€‚

å°½ç®¡ä¸€ä¸ªç»™å®šçš„å®ä¾‹å¯ç”¨äº 3 ä¸ªè§’è‰²ï¼Œä½†é€šå¸¸ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…è¢«åˆ›å»ºä¸ºä¸ºå¤šä¸ªå®ä¾‹ã€‚é€šè¿‡ç»™å®šé˜Ÿåˆ—çš„ä¾‹åŒ–åç§°ï¼ˆå¦‚ä¸Šé¢çš„ç¤ºä¾‹ä¸­çš„`my-first-queue`ï¼‰æ¥å¼•ç”¨å®ƒï¼Œä¸€ä¸ªåˆ—é˜Ÿå¯ä»¥å…·æœ‰è®¸å¤šç”Ÿäº§è€…ã€è®¸å¤šä½¿ç”¨è€…å’Œè®¸å¤šä¾¦å¬å™¨ã€‚ä¸€ä¸ªé‡è¦çš„æ–¹é¢æ˜¯ï¼Œç”Ÿäº§è€…å¯ä»¥æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—ï¼Œå³ä½¿å½“æ—¶æ²¡æœ‰å¯ç”¨çš„æ¶ˆè´¹è€…ï¼šé˜Ÿåˆ—æä¾›å¼‚æ­¥é€šä¿¡ï¼Œè¿™æ˜¯ä½¿å®ƒä»¬å¦‚æ­¤å¼ºå¤§çš„åŠŸèƒ½ä¹‹ä¸€ã€‚

ç›¸åï¼Œæ‚¨å¯ä»¥è®©ä¸€ä¸ªæˆ–å¤šä¸ªæ¶ˆè´¹è€…ä½¿ç”¨é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å°†æŒ‰æŒ‡å®šé¡ºåºæ¶ˆè´¹ä»»åŠ¡ï¼šFIFOï¼ˆé»˜è®¤å€¼ï¼‰ã€FIFO æˆ–æ ¹æ®ä¼˜å…ˆçº§æ¶ˆè´¹ä»»åŠ¡ã€‚

å…³äºå·¥ä½œåŒºé—´ï¼Œå®ƒä»¬å¯ä»¥åœ¨åŒä¸€ä¸ªæˆ–ä¸åŒçš„è¿›ç¨‹ä¸­ã€åœ¨åŒä¸€å°è®¡ç®—æœºæˆ–ç¾¤é›†ä¸­è¿è¡Œã€‚Redis å°†ä½œä¸ºä¸€ä¸ªå…¬å…±ç«¯ç‚¹ï¼Œåªè¦æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…å¯ä»¥è¿æ¥åˆ° Redisï¼Œä»–ä»¬å°†èƒ½å¤Ÿåˆä½œå¤„ç†ä»»åŠ¡ã€‚

#### ç”Ÿäº§è€…

ä»»åŠ¡ç”Ÿäº§è€…åªæ˜¯å°†ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—çš„ä¸€äº›Nodeç¨‹åºï¼Œå¦‚ï¼š

```javascript
const myFirstQueue = new Bull('my-first-queue');

const job = await myFirstQueue.add({
  foo: 'bar'
});
```

å¦‚æ‚¨æ‰€çœ‹åˆ°çš„ï¼Œä»»åŠ¡åªæ˜¯ä¸€ä¸ª javascript å¯¹è±¡ã€‚æ­¤å¯¹è±¡å¿…é¡»å¯è¢«åºåˆ—åŒ–ï¼Œæ›´å…·ä½“åœ°è¯´åº”è¯¥å¯ä»¥è¢«`JSON.stringify`è½¬åŒ–ä¸ºå­—ç¬¦ä¸²ï¼Œå› ä¸ºè¿™å°±æ˜¯å®ƒå­˜å‚¨åœ¨ Redis ä¸­çš„å½¢å¼ã€‚

ä¹Ÿå¯ä»¥åœ¨ä»»åŠ¡æ•°æ®å¯¹è±¡å‚æ•°ä¹‹åæä¾›ä¸€ä¸ªé€‰é¡¹å¯¹è±¡å‚æ•°ï¼Œåé¢æˆ‘ä»¬å°†ä»‹ç»è¿™ä¸€ç‚¹ã€‚

#### æ¶ˆè´¹è€…

æ¶ˆè´¹è€…æˆ–å·¥ä½œåŒºé—´ï¼Œåªä¸è¿‡æ˜¯ä¸€ä¸ªNodeç¨‹åºï¼Œå®ƒå®šä¹‰äº†ä¸€ä¸ªæµç¨‹å‡½æ•°ï¼Œå¦‚ï¼š

```javascript
const myFirstQueue = new Bull('my-first-queue');

myFirstQueue.process(async (job) => {
  return doSomething(job.data);
});
```

æ¯æ¬¡å·¥ä½œåŒºé—´ç©ºé—²ä¸”é˜Ÿåˆ—ä¸­æœ‰ä»»åŠ¡è¢«ç­‰å¾…å¤„ç†æ—¶ï¼Œéƒ½ä¼šè°ƒç”¨è¯¥ä»»åŠ¡çš„`process`å‡½æ•°ã€‚ç”±äºæ·»åŠ ä»»åŠ¡æ—¶æ¶ˆè´¹è€…ä¸éœ€è¦åœ¨çº¿(æ·»åŠ å’Œæ¶ˆè´¹æ˜¯å¼‚æ­¥çš„)ï¼Œå› æ­¤ä¼šæœ‰è®¸å¤šä»»åŠ¡å †ç§¯åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…æ¶ˆè´¹ï¼Œç›´åˆ°å…¨éƒ¨å¤„ç†å®Œã€‚

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬å°†`process`å‡½æ•°å®šä¹‰ä¸º `async`ï¼Œè¿™æ˜¯å¼ºçƒˆå»ºè®®çš„å®šä¹‰æ–¹æ³•ã€‚å¦‚æœæ‚¨çš„ Node è¿è¡Œæ—¶ä¸æ”¯æŒå¼‚æ­¥/ç­‰å¾…ï¼Œé‚£ä¹ˆæ‚¨åªéœ€åœ¨è¿›ç¨‹å‡½æ•°çš„æœ«å°¾è¿”å›ä¸€ä¸ª`Promise`ï¼Œä»¥å–å¾—ç±»ä¼¼çš„ç»“æœã€‚

`process`å‡½æ•°è¿”å›çš„å€¼å°†å­˜å‚¨åœ¨ä»»åŠ¡`job`å®ä¾‹ä¸­ï¼Œæ–¹ä¾¿åé¢å¯ä»¥è®¿é—®ï¼Œä¾‹å¦‚åœ¨ç›‘å¬å™¨çš„`completed`äº‹ä»¶ä¸­å¯ä»¥é€šè¿‡`progress`å‡½æ•°æ¥è®¿é—®`job`å®ä¾‹ï¼š

```javascript
myFirstQueue.process( async (job) => {
  let progress = 0;
  for(i = 0; i < 100; i++){
    await doSomething(job.data);
    progress += 10;
    job.progress(progress);
  }
});
```

#### ç›‘å¬å™¨

æœ€åï¼Œæ‚¨å¯ä»¥ç›‘å¬é˜Ÿåˆ—ä¸­è§¦å‘çš„äº‹ä»¶ã€‚å¦‚æœæ˜¯æœ¬åœ°ç›‘å¬å™¨åˆ™åªæ¥æ”¶åœ¨æŒ‡å®šçš„é˜Ÿåˆ—å®ä¾‹ä¸­ç”Ÿæˆçš„é€šçŸ¥ï¼Œå¦‚æœæ˜¯å…¨å±€ç›‘å¬å™¨å°±ä¼šç›‘å¬æŒ‡å®šé˜Ÿåˆ—çš„æ‰€æœ‰äº‹ä»¶ã€‚å› æ­¤ï¼Œæ‚¨å¯ä»¥å°†ç›‘å¬å™¨æ·»åŠ åˆ°ä»»ä½•å®ä¾‹ï¼Œç”šè‡³å……å½“æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…çš„å®ä¾‹ã€‚ä½†è¯·æ³¨æ„ï¼Œå¦‚æœé˜Ÿåˆ—ä¸æ˜¯æ¶ˆè´¹è€…æˆ–ç”Ÿäº§è€…ï¼Œåˆ™æœ¬åœ°äº‹ä»¶æ°¸è¿œä¸ä¼šè§¦å‘ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ‚¨éœ€è¦ä½¿ç”¨å…¨å±€äº‹ä»¶ã€‚

```javascript
const myFirstQueue = new Bull('my-first-queue');

// Define a local completed event
myFirstQueue.on('completed', (job, result) => {
  console.log(`Job completed with result ${result}`);
})
```

#### ç”Ÿå‘½å‘¨æœŸ

ä¸ºäº†å……åˆ†åˆ©ç”¨ Bull é˜Ÿåˆ—çš„å…¨éƒ¨æ½œåŠ›ï¼Œäº†è§£ä»»åŠ¡çš„ç”Ÿå‘½å‘¨æœŸéå¸¸é‡è¦ã€‚ä»ç”Ÿäº§è€…åœ¨é˜Ÿåˆ—å®ä¾‹ä¸Šè°ƒç”¨`add`æ–¹æ³•çš„é‚£ä¸€åˆ»èµ·ï¼Œä»»åŠ¡è¿›å…¥ä¸€ä¸ªç”Ÿå‘½å‘¨æœŸï¼Œè¯¥ç”Ÿå‘½å‘¨æœŸå°†å¤„äºä¸åŒçš„çŠ¶æ€ï¼Œç›´åˆ°å®Œæˆæˆ–å¤±è´¥ï¼ˆå°½ç®¡ä»æŠ€æœ¯ä¸Šè®²ï¼Œå¤±è´¥çš„ä»»åŠ¡å¯ä»¥é‡è¯•å¹¶è·å¾—æ–°çš„ç”Ÿå‘½å‘¨æœŸï¼‰ã€‚

![Diagram showing job statuses](https://optimalbits.github.io/bull/job-lifecycle.png)

å½“ä»»åŠ¡æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­æ—¶ï¼Œå®ƒå¯å¤„äº**ç­‰å¾…çŠ¶æ€**æˆ–**å»¶è¿ŸçŠ¶æ€**ã€‚ç­‰å¾…çŠ¶æ€å…¶å®æ˜¯ä¸€ä¸ªç­‰å¾…åˆ—è¡¨ï¼Œæ‰€æœ‰åˆ—é˜Ÿåœ¨å¤„ç†ä¹‹å‰å‡å¤„äºç­‰å¾…çŠ¶æ€ï¼Œå»¶è¿ŸçŠ¶æ€æ„å‘³ç€ä»»åŠ¡æ­£åœ¨ç­‰å¾…æŸäº›è¶…æ—¶æˆ–å¤„ç†å¤±è´¥çš„ä»»åŠ¡ï¼Œå»¶è¿Ÿä»»åŠ¡ä¸ä¼šç›´æ¥å¤„ç†ï¼Œè€Œæ˜¯åœ¨å·¥ä½œåŒºé—´å¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œå°†å…¶æ”¾ç½®åœ¨ç­‰å¾…åˆ—è¡¨çš„å¼€å¤´å¹¶è¿›è¡Œå¤„ç†ã€‚

ä»»åŠ¡çš„ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸º"æ´»åŠ¨"çŠ¶æ€ã€‚æ´»åŠ¨çŠ¶æ€ç”±ä¸€Redisçš„`set`é›†è¡¨ç¤ºï¼Œæ˜¯å½“å‰æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œè¿™æ—¶å®ƒä»¬åœ¨`process`å‡½æ•°ä¸­è¿è¡Œã€‚ä»»åŠ¡å¯ä»¥æ— é™æ—¶é—´çš„å¤„äºå¤„äºæ´»åŠ¨çŠ¶æ€ï¼Œç›´åˆ°è¿‡ç¨‹å®Œæˆæˆ–å¼•å‘å¼‚å¸¸ï¼Œä»¥ä¾¿ä»»åŠ¡ä»¥"å·²å®Œæˆ"æˆ–"å¤±è´¥"çŠ¶æ€ç»“æŸã€‚

#### åœæ»ä»»åŠ¡

åœ¨ Bullä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†åœæ»ä»»åŠ¡çš„æ¦‚å¿µã€‚åœæ»ä»»åŠ¡è™½ç„¶æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ï¼Œä½† Bull æ€€ç–‘æµç¨‹åŠŸèƒ½å·²æŒ‚èµ·ã€‚å½“`process`å‡½æ•°æ­£åœ¨å¤„ç†çš„ä»»åŠ¡ä½¿ CPU è´Ÿè½½è¿‡å¤§æ—¶ï¼Œä¼šå¯¼è‡´å·¥ä½œåŒºé—´æ— æ³•å‘Šè¯‰é˜Ÿåˆ—å®ƒä»åœ¨å¤„ç†è¯¥ä»»åŠ¡ï¼Œè¿™æ—¶ä¼šé€ æˆåœæ»ä»»åŠ¡ã€‚

å½“ä»»åŠ¡åœæ»æ—¶ï¼Œæ ¹æ®ä»»åŠ¡çš„è®¾ç½®ï¼Œä»»åŠ¡å¯ç”±å…¶ä»–ç©ºé—²å·¥ä½œåŒºé—´é‡è¯•ï¼Œä¹Ÿå¯ä»¥åˆ‡æ¢åˆ°å¤±è´¥çŠ¶æ€ã€‚

åœæ»ä»»åŠ¡å¯ä»¥é€šè¿‡ç¡®ä¿è¿›ç¨‹å‡½æ•°ä¸ä¼šä½¿ Node äº‹ä»¶å¾ªç¯è¿è¡Œæ—¶é—´å¤ªé•¿ï¼Œæˆ–ä½¿ç”¨å•ç‹¬çš„[æ²™ç›’å¤„ç†å™¨](#ç‹¬ç«‹è¿›ç¨‹)æ¥é¿å…ã€‚

### äº‹ä»¶

Bull ä¸­çš„é˜Ÿåˆ—æ‹¥æœ‰å‡ ä¸ªäº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶åœ¨è®¸å¤šç”¨ä¾‹ä¸­å¾ˆæœ‰ç”¨ã€‚äº‹ä»¶å¯ä»¥æ˜¯ä¸€ä¸ªåˆ—é˜Ÿå®ä¾‹(ä¸€ä¸ªå·¥ä½œåŒºé—´)çš„æœ¬åœ°äº‹ä»¶ï¼Œä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªä»»åŠ¡åœ¨ç»™å®šå·¥ä½œåŒºé—´å†…å®Œæˆï¼Œåˆ™å°†åªä¸ºè¯¥å®ä¾‹å‘å‡ºæœ¬åœ°äº‹ä»¶ã€‚ä½†æ˜¯ï¼Œå¯ä»¥ç›‘å¬æ‰€æœ‰äº‹ä»¶ï¼Œä¾‹å¦‚åœ¨æœ¬åœ°äº‹ä»¶åç§°å‰åŠ ä¸Š`global:`å‰ç¼€ã€‚ç„¶åï¼Œæˆ‘ä»¬å¯ä»¥ç›‘å¬æŒ‡å®šé˜Ÿåˆ—çš„æ‰€æœ‰å·¥ä½œåŒºé—´ç”Ÿæˆçš„æ‰€æœ‰äº‹ä»¶ã€‚

ä¸€ä¸ªæœ¬åœ°çš„`completed`äº‹ä»¶:

```javascript
queue.on('completed', job => {
  console.log(`Job with id ${job.id} has been completed`);
})
```

è€Œä¸‹é¢è¿™æ ·å°±å¯ä»¥é€šè¿‡å…¨å±€æ¥ç›‘å¬:

```javascript
queue.on('global:completed', jobId => {
  console.log(`Job with id ${jobId} has been completed`);
})
```

è¯·æ³¨æ„ï¼Œå…¨å±€äº‹ä»¶çš„ç­¾åä¸æœ¬åœ°äº‹ä»¶çš„ç­¾åç•¥æœ‰ä¸åŒï¼Œåœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå®ƒåªå‘é€ä»»åŠ¡çš„ ID è€Œä¸æ˜¯ä»»åŠ¡æœ¬èº«çš„å®Œæ•´å®ä¾‹ï¼Œè¿™æ ·åšæ˜¯å‡ºäºæ€§èƒ½åŸå› ã€‚

å¯ç”¨äº‹ä»¶çš„åˆ—è¡¨å¯åœ¨[referenceæ–‡æ¡£] (https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#eventsk)ä¸­æ‰¾åˆ°ã€‚

### åˆ—é˜Ÿé€‰é¡¹

é˜Ÿåˆ—å¯ä»¥åœ¨å®ä¾‹åŒ–æ—¶å¯ä»¥ä¼ å…¥ä¸€äº›é€‰é¡¹ï¼Œä¾‹å¦‚ï¼Œæ‚¨å¯ä»¥æŒ‡å®š Redis æœåŠ¡å™¨çš„åœ°å€å’Œå¯†ç ï¼Œä»¥åŠå…¶ä»–ä¸€äº›æœ‰ç”¨çš„è®¾ç½®ã€‚æ‰€æœ‰è¿™äº›è®¾ç½®éƒ½åœ¨ Bull çš„[referenceæ–‡æ¡£](https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queue)ä¸­æ‰¾åˆ°ï¼Œä¸‹é¢æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸€äº›é€‰é¡¹çš„ç”¨ä¾‹

> æ›´å¤šè¯¦ç»†çš„APIè¯·å‚è€ƒ[æ–‡æ¡£](https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queue)

#### é€Ÿç‡é™åˆ¶

ä¸ºåˆ›å»ºçš„é˜Ÿåˆ—é™åˆ¶åœ¨æ—¶é—´å•ä½ä¸­å¤„ç†çš„ä»»åŠ¡æ•°ã€‚é™åˆ¶æ˜¯æ¯ä¸ªé˜Ÿåˆ—å®šä¹‰çš„ï¼Œä¸å·¥ä½œåŒºé—´æ•°é‡ä¸ä¸€ï¼Œå› æ­¤æ‚¨å¯ä»¥æ°´å¹³ç¼©æ”¾ï¼Œå¹¶ä¸”ä»ç„¶èƒ½å¤Ÿè½»æ¾é™åˆ¶å¤„ç†é€Ÿç‡é™åˆ¶ï¼š

```javascript
// Limit queue to max 1.000 jobs per 5 seconds.
const myRateLimitedQueue = new Queue('rateLimited', {
  limiter: {
    max: 1000,
    duration: 5000
  }
});
```

å½“é˜Ÿåˆ—è¾¾åˆ°é€Ÿç‡é™åˆ¶æ—¶ï¼Œè¯·æ±‚çš„ä»»åŠ¡å°†åŠ å…¥`delayed`é˜Ÿåˆ—ã€‚

#### å‘½åä»»åŠ¡

å¯ä»¥ç»™ä»»åŠ¡å‘½åä¸ä¼šæ”¹å˜é˜Ÿåˆ—çš„ä»»ä½•æœºåˆ¶ï¼Œä½†å¯è·å¾—æ›´æ¸…æ™°çš„ä»£ç ä»¥åŠåœ¨UI å·¥å…·ä¸­çš„æ›´å¥½å¯è§†åŒ–ï¼š

```javascript
// Jobs producer
const myJob = await transcoderQueue.add('image', { input: 'myimagefile' });
const myJob = await transcoderQueue.add('audio', { input: 'myaudiofile' });
const myJob = await transcoderQueue.add('video', { input: 'myvideofile' });
// Worker
transcoderQueue.process('image', processImage);
transcoderQueue.process('audio', processAudio);
transcoderQueue.process('video', processVideo);
```

è¯·è®°ä½ï¼Œæ¯ä¸ªé˜Ÿåˆ—å®ä¾‹éƒ½éœ€è¦ä¸ºæ¯ä¸ªå‘½åä»»åŠ¡æä¾›*ä¸€ä¸ª*å¤„ç†å™¨ï¼Œå¦åˆ™å°†æŠ›å‡ºå¼‚å¸¸ã€‚

#### æ²™ç›’å¤„ç†å™¨

å¦‚ä¸Šæ‰€è¿°ï¼Œåœ¨å®šä¹‰`process`å‡½æ•°æ—¶ï¼Œè¿˜å¯ä»¥æä¾›å¹¶å‘è®¾ç½®ã€‚æ­¤è®¾ç½®å…è®¸å·¥ä½œäººå‘˜å¹¶è¡Œå¤„ç†å¤šä¸ªä»»åŠ¡ã€‚ä»»åŠ¡ä»åœ¨åŒä¸€Nodeè¿›ç¨‹ä¸­å¤„ç†ï¼Œå°±ç®—å¤„ç†çš„OIå¯†é›†éå¸¸é«˜çš„ä»»åŠ¡ä¹Ÿä¼šå¤„ç†æ­£å¸¸ã€‚

ä½†æ˜¯æœ‰æ—¶éœ€è¦å¤„ç†CPUå¯†é›†éå¸¸é«˜çš„ä»»åŠ¡ï¼Œè¿™å¯èƒ½ä¼šé”å®šNodeäº‹ä»¶å¾ªç¯å¤ªä¹…è€Œå¯¼è‡´Bull å¯èƒ½ä¼šåœæ­¢ä»»åŠ¡ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œå¯ä»¥åœ¨å•ç‹¬çš„Nodeè¿›ç¨‹ä¸­çš„è¿è¡Œ`process`å‡½æ•°ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¹¶å‘å‚æ•°å°†å†³å®šå…è®¸è¿è¡Œçš„å¹¶å‘è¿›ç¨‹çš„æœ€å¤§æ•°é‡ã€‚

æˆ‘ä»¬ç§°è¿™ç§è¿›ç¨‹ä¸º"æ²™ç›’"è¿›ç¨‹ï¼Œè¿™æ ·å°±ç®—æŸä¸ªè¿›ç¨‹å´©æºƒä¹Ÿä¸ä¼šå½±å“ä»»ä½•å…¶ä»–è¿›ç¨‹ï¼Œå¹¶ä¸”å°†è‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªæ–°è¿›ç¨‹æ¥å–ä»£å®ƒã€‚

### ä»»åŠ¡ç±»å‹

Bull ä¸­çš„é»˜è®¤ä»»åŠ¡ç±»å‹æ˜¯"FIFO"ï¼ˆå…ˆå‡ºï¼‰ï¼Œè¿™æ„å‘³ç€ä»»åŠ¡çš„å¤„ç†é¡ºåºä¸è¿›å…¥é˜Ÿåˆ—çš„é¡ºåºç›¸åŒã€‚æŒ‰ä¸åŒé¡ºåºå¤„ç†ä»»åŠ¡æ—¶è¿™å¾ˆæœ‰ç”¨ã€‚

#### LIFO

Lifoï¼ˆæœ€åä¸€ä¸ªå…ˆå‡ºï¼‰è¡¨ç¤ºä»»åŠ¡è¢«æ·»åŠ åˆ°é˜Ÿåˆ—çš„å¼€å¤´ï¼Œå› æ­¤å°†åœ¨å·¥ä½œåŒºé—´ç©ºé—²æ—¶è¿›è¡Œå¤„ç†ã€‚

```javascript
const myJob = await myqueue.add({ foo: 'bar' }, { lifo: true });
```

#### å»¶è¿Ÿ

ä½¿ä»»åŠ¡åœ¨å¤„ç†ä¹‹å‰å»¶è¿Ÿä¸€å®šæ—¶é—´ã€‚è¯·æ³¨æ„ï¼Œå»¶è¿Ÿå‚æ•°è¡¨ç¤ºä»»åŠ¡åœ¨è¿›è¡Œå¤„ç†ä¹‹å‰ç­‰å¾…çš„æœ€çŸ­æ—¶é—´é‡ã€‚å»¶è¿Ÿæ—¶é—´è¿‡æ—¶ï¼Œä»»åŠ¡å°†ç§»åŠ¨åˆ°åˆ—é˜Ÿçš„å¼€å¤´ï¼Œå¹¶åœ¨å·¥ä½œåŒºé—´ç©ºé—²æ—¶è¿›è¡Œå¤„ç†ã€‚

```javascript
// Delayed 5 seconds
const myJob = await myqueue.add({ foo: 'bar' }, { delay: 5000 });
```

#### ä¼˜å…ˆçº§

ä»»åŠ¡å¯ä»¥è®¾ç½®ä¼˜å…ˆçº§ã€‚ä¼˜å…ˆçº§è¾ƒé«˜çš„ä»»åŠ¡å°†åœ¨ä¼˜å…ˆçº§è¾ƒä½çš„ä»»åŠ¡ä¹‹å‰è¿›è¡Œå¤„ç†ã€‚æœ€é«˜ä¼˜å…ˆçº§ä¸º 1ï¼Œæ•°å€¼è¶Šå¤§ä¼˜å…ˆçº§æœˆåº•ã€‚è¯·è®°ä½ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—æ¯”æ ‡å‡†é˜Ÿåˆ—æ…¢ä¸€ç‚¹ï¼ˆå› ä¸ºä¼˜å…ˆçº§åˆ—é˜Ÿçš„å½“å‰æ’å…¥æ—¶é—´ O(n)çš„ä¼šæ›¿ä»£æ ‡å‡†é˜Ÿåˆ—çš„O(1))ã€‚

> ä¸Šé¢æ‹¬å·ä¸­çš„n ä»£è¡¨å½“å‰åœ¨é˜Ÿåˆ—ä¸­ç­‰å¾…çš„ä»»åŠ¡æ•°

```javascript
const myJob = await myqueue.add({ foo: 'bar' }, { priority: 3 });
```

#### é‡å¤

å¯é‡å¤ä»»åŠ¡æ˜¯ç‰¹æ®Šä»»åŠ¡ï¼Œæ ¹æ® cron è§„èŒƒæˆ–æ—¶é—´é—´éš”ï¼Œå¯ä»¥æ— é™æœŸåœ°é‡å¤ï¼Œç›´åˆ°ç»™å®šçš„æœ€å¤§æ—¶é—´æˆ–åˆ°è¾¾é‡å¤æ¬¡æ•°æ‰åœæ­¢(å¦‚æœè®¾ç½®è¿™ä¸¤è€…çš„è¯)ã€‚

```javascript
// Repeat every 10 seconds for 100 times.
const myJob = await myqueue.add(
  { foo: 'bar' },
  {
    repeat: {
      every: 10000,
      limit: 100
    }
  }
);

// Repeat payment job once every day at 3:15 (am)
paymentsQueue.add(paymentsData, { repeat: { cron: '15 3 * * *' } });
```

å…³äºå¯é‡å¤ä»»åŠ¡ï¼Œæœ‰ä¸€äº›é‡è¦çš„æ³¨æ„äº‹é¡¹ï¼š

- å¦‚æœé‡å¤é€‰é¡¹ç›¸åŒï¼ŒBull ä¸ä¼šæ·»åŠ ç›¸åŒçš„å¯é‡å¤ä»»åŠ¡ã€‚ï¼ˆæ³¨æ„ï¼šä»»åŠ¡ ID æ˜¯é‡å¤é€‰é¡¹çš„ä¸€éƒ¨åˆ†ï¼Œå› ä¸ºï¼šhttps://github.com/OptimalBits/bull/pull/603ï¼Œå› æ­¤ä¼ é€’ä»»åŠ¡ ID å°†å…è®¸åœ¨é˜Ÿåˆ—ä¸­æ’å…¥å…·æœ‰ç›¸åŒ cron çš„ä»»åŠ¡ï¼‰
- å¦‚æœæ²¡æœ‰æ­£åœ¨è¿è¡Œçš„å·¥ä½œåŒºé—´ï¼Œåˆ™ä¸‹æ¬¡å·¥ä½œåŒºé—´åœ¨çº¿æ—¶ï¼Œå¯é‡å¤ä»»åŠ¡å°†ä¸ç´¯ç§¯ã€‚
- å¯é‡å¤ä»»åŠ¡å¯ä»¥é€šè¿‡ [removeRepeatable](https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueremoverepeatable)æ–¹æ³•åˆ é™¤

## å¦‚ä½•ä½¿ç”¨

### åŸºæœ¬ä½¿ç”¨

```js
var Queue = require('bull');

var videoQueue = new Queue('video transcoding', 'redis://127.0.0.1:6379');
var audioQueue = new Queue('audio transcoding', {redis: {port: 6379, host: '127.0.0.1', password: 'foobared'}}); // Specify Redis connection using object
var imageQueue = new Queue('image transcoding');
var pdfQueue = new Queue('pdf transcoding');

videoQueue.process(function(job, done){

  // job.data contains the custom data passed when the job was created
  // job.id contains id of this job.

  // transcode video asynchronously and report progress
  job.progress(42);

  // call done when finished
  done();

  // or give a error if error
  done(new Error('error transcoding'));

  // or pass it a result
  done(null, { framerate: 29.5 /* etc... */ });

  // If the job throws an unhandled exception it is also handled correctly
  throw new Error('some unexpected error');
});

audioQueue.process(function(job, done){
  // transcode audio asynchronously and report progress
  job.progress(42);

  // call done when finished
  done();

  // or give a error if error
  done(new Error('error transcoding'));

  // or pass it a result
  done(null, { samplerate: 48000 /* etc... */ });

  // If the job throws an unhandled exception it is also handled correctly
  throw new Error('some unexpected error');
});

imageQueue.process(function(job, done){
  // transcode image asynchronously and report progress
  job.progress(42);

  // call done when finished
  done();

  // or give a error if error
  done(new Error('error transcoding'));

  // or pass it a result
  done(null, { width: 1280, height: 720 /* etc... */ });

  // If the job throws an unhandled exception it is also handled correctly
  throw new Error('some unexpected error');
});

pdfQueue.process(function(job){
  // Processors can also return promises instead of using the done callback
  return pdfAsyncProcessor();
});

videoQueue.add({video: 'http://example.com/video1.mov'});
audioQueue.add({audio: 'http://example.com/audio1.mp3'});
imageQueue.add({image: 'http://example.com/image1.tiff'});
```

### ä½¿ç”¨promises

ä½ å¯ä»¥è¿”å› promisesæ¥æ›¿ä»£ `done` å›è°ƒå‡½æ•°:

```javascript
videoQueue.process(function(job){ // don't forget to remove the done callback!
  // Simply return a promise
  return fetchVideo(job.data.url).then(transcodeVideo);

  // Handles promise rejection
  return Promise.reject(new Error('error transcoding'));

  // Passes the value the promise is resolved with to the "completed" event
  return Promise.resolve({ framerate: 29.5 /* etc... */ });

  // If the job throws an unhandled exception it is also handled correctly
  throw new Error('some unexpected error');
  // same as
  return Promise.reject(new Error('some unexpected error'));
});
```

### ç‹¬ç«‹è¿›ç¨‹

`process`å‡½æ•°å¯ä»¥è¿è¡Œåœ¨ç‹¬ç«‹è¿›ç¨‹ä¸­ . è¿™æ ·åšæœ‰ä¸€ä¸‹å‡ ä¸ªä¼˜ç‚¹:

- è¿›ç¨‹æ˜¯ä¸€ä¸ªæ²™ç›’ï¼Œæ‰€ä»¥å°±ç®—å´©æºƒä¹Ÿä¸ä¼šå½±å“å…¶å®ƒç¨‹åºå·¥ä½œã€‚
- ä½ å¯ä»¥åœ¨ä¸å½±å“åˆ—é˜Ÿçš„æƒ…å†µä¸‹è¿è¡Œé˜»å¡ä»£ç  ï¼ˆä»»åŠ¡ä¸ä¼šåœæ»ï¼‰ã€‚
- å¤šæ ¸CPUçš„åˆ©ç”¨ç‡è¦å¥½å¾—å¤šã€‚
- ä¸Redisçš„è¿æ¥æ›´å°‘ã€‚

è¦è¿è¡Œæ­¤åŠŸèƒ½åªéœ€è¦åˆ›å»ºå•ç‹¬çš„æ–‡ä»¶ï¼š

```js
// processor.js
module.exports = function(job){
  // Do some heavy work

  return Promise.resolve(result);
}
```

å¹¶å®šä¹‰å¤„ç†å™¨ï¼Œåƒè¿™æ ·ï¼š

```js
// Single process:
queue.process('/path/to/my/processor.js');

// You can use concurrency as well:
queue.process(5, '/path/to/my/processor.js');

// and named processors:
queue.process('my processor', 5, '/path/to/my/processor.js');
```

### é‡å¤ä»»åŠ¡

ä»»åŠ¡å¯ä»¥æ·»åŠ åˆ°é˜Ÿåˆ—ä¸­ï¼Œå¹¶æ ¹æ® cron è§„èŒƒé‡å¤å¤„ç†ï¼š

```
  paymentsQueue.process(function(job){
    // Check payments
  });

  // Repeat payment job once every day at 3:15 (am)
  paymentsQueue.add(paymentsData, {repeat: {cron: '15 3 * * *'}});

```

åœ¨[æ­¤å¤„](https://crontab.cronhub.io)æ£€æŸ¥è¡¨è¾¾å¼ä»¥éªŒè¯å®ƒä»¬æ˜¯å¦æ­£ç¡®

### æš‚åœ / æ¢å¤

A queue can be paused and resumed globally (pass `true` to pause processing for
just this worker):

å¯ä»¥å…¨å±€æš‚åœå’Œæ¢å¤é˜Ÿåˆ—ï¼ˆé€šè¿‡æ­¤å·¥ä½œåŒºé—´çš„æš‚åœå¤„ç†ï¼‰ï¼š`true`

```js
queue.pause().then(function(){
  // queue is paused now
});

queue.resume().then(function(){
  // queue is resumed now
})
```

### äº‹ä»¶

é˜Ÿåˆ—ä¼šè§¦å‘ä¸€äº›æœ‰ç”¨çš„äº‹ä»¶ï¼Œä¾‹å¦‚...

```js
.on('completed', function(job, result){
  // Job completed with output result!
})
```

æœ‰å…³äº‹ä»¶ï¼ˆåŒ…æ‹¬å·²è§¦å‘äº‹ä»¶çš„å®Œæ•´åˆ—è¡¨ï¼‰çš„ä¿¡æ¯ï¼Œè¯·æŸ¥çœ‹[äº‹ä»¶å‚è€ƒ](https://github.com/OptimalBits/bull/blob/develop/REFERENCE.md#events)

### é˜Ÿåˆ—æ€§èƒ½

é˜Ÿåˆ—å¾ˆä¾¿å®œï¼Œå› æ­¤å¦‚æœæ‚¨éœ€è¦å…¶ä¸­çš„è®¸å¤šé˜Ÿåˆ—ï¼Œåªéœ€åˆ›å»ºå…·æœ‰ä¸åŒåç§°çš„æ–°é˜Ÿåˆ—ï¼š

```javascript
var userJohn = new Queue('john');
var userLisa = new Queue('lisa');
.
.
.
```

ä½†æ˜¯ï¼Œæ¯ä¸ªé˜Ÿåˆ—å®ä¾‹éƒ½éœ€è¦æ–°çš„Redisè¿æ¥ï¼ŒæŸ¥çœ‹[å¦‚ä½•é‡ç”¨è¿æ¥](https://github.com/OptimalBits/bull/blob/master/PATTERNS.md#reusing-redis-connections)ï¼Œæˆ–è€…æ‚¨ä¹Ÿå¯ä»¥ä½¿ç”¨[å‘½åä»»åŠ¡](https://github.com/OptimalBits/bull/blob/master/REFERENCE.md#queueprocess)æ¥å®ç°ç±»ä¼¼çš„ç»“æœã€‚

### ~~ç¾¤é›†æ”¯æŒ~~

> ä»ç‰ˆæœ¬ 3.2.0 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå»ºè®®ä½¿ç”¨çº¿ç¨‹å¤„ç†å™¨ã€‚

```js
var
  Queue = require('bull'),
  cluster = require('cluster');

var numWorkers = 8;
var queue = new Queue("test concurrent queue");

if(cluster.isMaster){
  for (var i = 0; i < numWorkers; i++) {
    cluster.fork();
  }

  cluster.on('online', function(worker) {
    // Lets create a few jobs for the queue workers
    for(var i=0; i<500; i++){
      queue.add({foo: 'bar'});
    };
  });

  cluster.on('exit', function(worker, code, signal) {
    console.log('worker ' + worker.process.pid + ' died');
  });
}else{
  queue.process(function(job, jobDone){
    console.log("Job done by worker", cluster.worker.id, job.id);
    jobDone();
  });
}
```

## å®˜æ–¹æ–‡æ¡£

æœ‰å…³å®Œæ•´æ–‡æ¡£ï¼Œè¯·æŸ¥çœ‹å®˜æ–¹wiki